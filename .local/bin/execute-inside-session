#!/bin/sh

# Get first graphical session
GRAPHICAL=$(loginctl show-user $UID | grep ^Display=)
GRAPHICAL=${GRAPHICAL#Display=}
GRAPHICAL=${GRAPHICAL[0]}

# Save the session leader PID
processes=$(loginctl show-session $GRAPHICAL | grep ^Leader=)
processes=${processes#Leader=}

# Get the first of the last grandchildren of the processes array which are not dbus-daemon instances
while [ -n "$processes" ]; do

	for process in $processes; do
		read children < /proc/$process/task/$process/children

		if [ -z "$children" ] && [ ! "/proc/$process/exe" -ef "/usr/bin/dbus-daemon" ]; then
			PID="$process"
			break
		fi

		list="$list $children"
	done

	processes=$list
	unset list children

done

# If $PID is empty then we failed miserably
[ -z $PID ] && exit 1

# Copy environment from that process
while read -d $'\0' variable; do
    export $variable
done < /proc/$PID/environ

# Execute command
exec "$@"
